{% extends "admin/change_form.html" %}

{% block extrahead %}
    {{ block.super }}
    
    <script type="text/javascript">
        $ = django.jQuery;
        var operators;

        var handleAttributeChange = $element => {
            var $rootElement = $element.parent().parent();
            var $operator = $rootElement.find('select[id*="operator"]');
            var $value = $rootElement.find('input[id*="value"]');

            clearOptionsFromOperator($operator);
            $value.val('');
            $value.show();
            $value.parent().find('a, br').remove();
            
            if ($element.val() == 'symptoms') {
                var attributeOperators = ['IN', 'NOT IN'];
                fillOperatorOptions($operator, attributeOperators);

                var possibleValues = [
                    {id: 1, value: 'Symptom 1'},
                    {id: 2, value: 'Symptom 2'},
                    {id: 3, value: 'Symptom 3'},
                ];
                fillPossibleValues($value, possibleValues);
            }
            else if ($element.val() == 'age') {
                var attributeOperators = ['gt', 'gte', 'lt', 'lte'];
                fillOperatorOptions($operator, attributeOperators);
            }
        }

        var fillOperatorOptions = ($operator, attributeOperators) => {
            var filtered_operators = operators.filter(operator => attributeOperators.includes(operator.value));
            filtered_operators.forEach(e => $operator.append($('<option>', { value: e.value, text: e.text })));
        }

        var fillPossibleValues = ($value, possibleValues) => {
            possibleValues.forEach(element => {
                $value.parent().prepend($('<br>'));
                $value.parent().prepend($('<a>', { href: 'javascript:;', text: element.value, id: element.id }));
            });
            $value.parent().find('a').on('click', handleValueClick);
            $value.parent().find('input').hide();
        }

        var handleValueClick = event => {
            var $target = $(event.target);
            var id = $target.attr('id');
            var textField = $(event.target).parent().find('input[id*="value"]');
            var values = textField.val().split(', ').filter(item => item);
            
            const index = values.indexOf(id);
            if (index > -1) {
                values.splice(index, 1);
                $target.css('fontWeight', 'normal');
            }
            else {
                $target.css('fontWeight', 'bold');
                values.push(id);
            }

            textField.val(values.join(', '));
        }

        var clearOptionsFromOperator = $element => {
            $element.find('option').map(function() { if ($(this).val() != "") { $(this).remove() } })
        }

		$(document).ready(function() {
            // Get available operators
            operators = $('#id_logical_conditions-0-operator option').map(function() {
                return { text: $(this).text(), value: $(this).val() };
            }).get();

            // Clean all operators
            document.querySelectorAll('select[id*="operator"]').forEach(element => clearOptionsFromOperator($(element)));
            
            $('select[id*="attribute"]').change(function(e) {
                handleAttributeChange($(this));
            });
		});
	</script>
{% endblock %}